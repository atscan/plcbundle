# .tangled/workflows/docker-release.yml

when:
  - event: ["push"]
    branch: ["refs/tags/*"]  # Trigger on any tag push
  - event: ["manual"]
    branch: ["main"]  # Allow manual trigger from main

engine: "nixery"

dependencies:
  nixpkgs:
    - docker
    - git
    - bash

environment:
  DOCKER_REGISTRY: "docker.io"
  DOCKER_IMAGE: "atscan/plcbundle"

steps:
  - name: "Extract version info"
    command: |
      # Extract version from tag or git
      if [[ "${TANGLED_REF}" =~ ^refs/tags/(.+)$ ]]; then
        VERSION="${BASH_REMATCH[1]}"
      else
        VERSION=$(git describe --tags --always --dirty)
      fi
      
      GIT_COMMIT=$(git rev-parse --short HEAD)
      BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      
      echo "VERSION=${VERSION}" >> $TANGLED_ENV
      echo "GIT_COMMIT=${GIT_COMMIT}" >> $TANGLED_ENV
      echo "BUILD_DATE=${BUILD_DATE}" >> $TANGLED_ENV
      
      echo "Building version: ${VERSION}"
      echo "Commit: ${GIT_COMMIT}"
      echo "Date: ${BUILD_DATE}"

  - name: "Set up Docker Buildx"
    command: |
      docker buildx create --use --name multiarch --driver docker-container
      docker buildx inspect --bootstrap

  - name: "Login to Docker Hub"
    command: |
      echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
    environment:
      DOCKER_USERNAME: "${{ secrets.DOCKER_USERNAME }}"
      DOCKER_PASSWORD: "${{ secrets.DOCKER_PASSWORD }}"

  - name: "Build and push multi-platform images"
    command: |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --build-arg VERSION="${VERSION}" \
        --build-arg GIT_COMMIT="${GIT_COMMIT}" \
        --build-arg BUILD_DATE="${BUILD_DATE}" \
        --tag ${DOCKER_IMAGE}:${VERSION} \
        --tag ${DOCKER_IMAGE}:latest \
        --push \
        .
      
      echo "✓ Pushed ${DOCKER_IMAGE}:${VERSION}"
      echo "✓ Pushed ${DOCKER_IMAGE}:latest"

  - name: "Verify images"
    command: |
      echo "Verifying pushed images..."
      docker buildx imagetools inspect ${DOCKER_IMAGE}:${VERSION}
